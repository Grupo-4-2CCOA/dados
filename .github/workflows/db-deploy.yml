name: Init MySQL Database

on:
  push:
    branches:
      - homologation

jobs:
  init-db:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      
      - name: SSH e executar initDatabase.sql via instÃ¢ncia ponte
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          PUBLIC_HOST: ${{ secrets.REMOTE_HOST_PUBLICO }}
          PRIVATE_HOST: ${{ secrets.REMOTE_HOST_PRIVADO }}
        run: |
          echo "$SSH_KEY" > bridge_key.pem
          chmod 600 bridge_key.pem

          scp -i bridge_key.pem -o StrictHostKeyChecking=no /mysql/sql/initDatabase.sql ubuntu@$PUBLIC_HOST:/tmp/

          ssh -i bridge_key.pem -o StrictHostKeyChecking=no ubuntu@$PUBLIC_HOST "
            ssh -i /path/to/private/key/on/public/instance -o StrictHostKeyChecking=no ubuntu@$PRIVATE_HOST '
              docker exec -i nome_do_container_mysql mysql -u user -ppassword < /tmp/initDatabase.sql
            '
          "
